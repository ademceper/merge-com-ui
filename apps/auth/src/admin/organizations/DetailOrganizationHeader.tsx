import { DropdownMenuItem } from "@merge/ui/components/dropdown-menu";
import { ViewHeader } from "../components/view-header/ViewHeader";
import { useTranslation } from "react-i18next";
import { useConfirmDialog } from "../components/confirm-dialog/ConfirmDialog";
import { useAdminClient } from "../admin-client";
import { useNavigate } from "react-router-dom";
import { getErrorDescription, getErrorMessage } from "../../shared/keycloak-ui-shared";
import { toast } from "@merge/ui/components/sonner";
import { Controller, useFormContext, useWatch } from "react-hook-form";
import { toOrganizations } from "./routes/Organizations";
import { useRealm } from "../context/realm-context/RealmContext";

type DetailOrganizationHeaderProps = {
    save: () => void;
};

export const DetailOrganizationHeader = ({ save }: DetailOrganizationHeaderProps) => {
    const { adminClient } = useAdminClient();
    const { realm } = useRealm();
    const navigate = useNavigate();

    const { t } = useTranslation();
const id = useWatch({ name: "id" });
    const name = useWatch({ name: "name" });

    const { setValue } = useFormContext();

    const [toggleDisableDialog, DisableConfirm] = useConfirmDialog({
        titleKey: "disableConfirmOrganizationTitle",
        messageKey: "disableConfirmOrganization",
        continueButtonLabel: "disable",
        onConfirm: () => {
            setValue("enabled", false);
            save();
        }
    });

    const [toggleDeleteDialog, DeleteConfirm] = useConfirmDialog({
        titleKey: "organizationDelete",
        messageKey: "organizationDeleteConfirm",
        continueButtonLabel: "delete",
        continueButtonVariant: "destructive",
        onConfirm: async () => {
            try {
                await adminClient.organizations.delById({ id });
                toast.success(t("organizationDeletedSuccess"));
                navigate(toOrganizations({ realm }));
            } catch (error) {
                toast.error(t("organizationDeleteError", { error: getErrorMessage(error) }), { description: getErrorDescription(error) });
            }
        }
    });

    return (
        <Controller
            name="enabled"
            render={({ field: { value, onChange } }) => (
                <>
                    <DeleteConfirm />
                    <DisableConfirm />
                    <ViewHeader
                        titleKey={name || ""}
                        divider={false}
                        dropdownItems={[
                            <DropdownMenuItem
                                data-testid="delete-client"
                                key="delete"
                                onClick={toggleDeleteDialog}
                            >
                                {t("delete")}
                            </DropdownMenuItem>
                        ]}
                        isEnabled={value}
                        onToggle={value => {
                            if (!value) {
                                toggleDisableDialog();
                            } else {
                                onChange(value);
                                save();
                            }
                        }}
                    />
                </>
            )}
        />
    );
};
